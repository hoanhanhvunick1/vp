name: Windows RDP via Ngrok (CÃ¡ch 1)

on: workflow_dispatch # Cháº¡y thá»§ cÃ´ng

jobs:
  build:
    runs-on: windows-latest # Cháº¡y trÃªn mÃ¡y áº£o Windows
    timeout-minutes: 9999 # Giá»¯ cháº¡y lÃ¢u nháº¥t cÃ³ thá»ƒ (trong giá»›i háº¡n cá»§a GitHub)

    steps:
    # BÆ°á»›c 1: Táº£i Ngrok
    - name: Táº£i Ngrok
      run: |
        Invoke-WebRequest https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip -OutFile ngrok.zip
        Expand-Archive ngrok.zip

    # BÆ°á»›c 2: XÃ¡c thá»±c Ngrok (Sá»¬ Dá»¤NG TOKEN TRá»°C TIáº¾P - KHÃ”NG AN TOÃ€N!)
    - name: Káº¿t ná»‘i tÃ i khoáº£n Ngrok (DÃ¹ng Token trá»±c tiáº¿p)
      # âš ï¸ Cáº¢NH BÃO: NhÃºng token trá»±c tiáº¿p lÃ  Ráº¤T KHÃ”NG AN TOÃ€N.
      #           HÃ£y sá»­ dá»¥ng GitHub Secrets thay tháº¿ náº¿u cÃ³ thá»ƒ.
      run: .\ngrok\ngrok.exe authtoken 2wJOyBLBh4cMau6pWvzMKVgbA3H_gfM4VLsnY57s6GFJ4ztm

    # BÆ°á»›c 3: KÃ­ch hoáº¡t RDP trÃªn Windows
    - name: KÃ­ch hoáº¡t truy cáº­p Remote Desktop (RDP)
      run: |
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -name "UserAuthentication" -Value 1
        Write-Host "âœ… ÄÃ£ kÃ­ch hoáº¡t RDP vÃ  má»Ÿ Firewall."

    # BÆ°á»›c 4: Táº¡o ngÆ°á»i dÃ¹ng vÃ  Ä‘áº·t máº­t kháº©u theo yÃªu cáº§u
    - name: Táº¡o ngÆ°á»i dÃ¹ng RDP vÃ  Ä‘áº·t máº­t kháº©u
      run: |
        $userName = "havpc01"
        $password = "pc01"
        # âš ï¸ Cáº¢NH BÃO: Máº­t kháº©u "pc01" Ráº¤T Yáº¾U! NÃªn sá»­ dá»¥ng máº­t kháº©u máº¡nh hÆ¡n.

        # Táº¡o Ä‘á»‘i tÆ°á»£ng máº­t kháº©u an toÃ n
        $secPassword = ConvertTo-SecureString $password -AsPlainText -Force

        # Táº¡o ngÆ°á»i dÃ¹ng cá»¥c bá»™ má»›i
        New-LocalUser -Name $userName -Password $secPassword -FullName "$userName (Created by GitHub Actions)" -Description "Temporary RDP User"

        # ThÃªm ngÆ°á»i dÃ¹ng vÃ o nhÃ³m Remote Desktop Users Ä‘á»ƒ cho phÃ©p Ä‘Äƒng nháº­p
        Add-LocalGroupMember -Group "Remote Desktop Users" -Member $userName

        # (TÃ¹y chá»n) ThÃªm ngÆ°á»i dÃ¹ng vÃ o nhÃ³m Administrators Ä‘á»ƒ cÃ³ quyá»n quáº£n trá»‹ cao hÆ¡n
        Add-LocalGroupMember -Group "Administrators" -Member $userName

        Write-Host "--------------------------------------------------"
        Write-Host "âœ… ÄÃ£ táº¡o ngÆ°á»i dÃ¹ng RDP thÃ nh cÃ´ng!"
        Write-Host "   ðŸ‘¤ TÃªn Ä‘Äƒng nháº­p (Username): $userName"
        Write-Host "   ðŸ”‘ Máº­t kháº©u (Password)    : $password (Cáº¢NH BÃO: Máº­t kháº©u yáº¿u!)"
        Write-Host "--------------------------------------------------"

    # BÆ°á»›c 5: Khá»Ÿi Ä‘á»™ng Ngrok Tunnel trong ná»n
    - name: Táº¡o Ngrok Tunnel cho RDP (Cá»•ng 3389)
      run: Start-Process Powershell -ArgumentList '-Noexit -Command ".\ngrok\ngrok.exe tcp 3389 --log=stdout"' # ThÃªm log Ä‘á»ƒ dá»… debug

    # BÆ°á»›c 6: Láº¥y vÃ  hiá»ƒn thá»‹ URL Ngrok
    - name: Láº¥y vÃ  hiá»ƒn thá»‹ Ä‘á»‹a chá»‰ káº¿t ná»‘i Ngrok
      run: |
        Start-Sleep -Seconds 10 # Chá» Ngrok khá»Ÿi Ä‘á»™ng vÃ  táº¡o tunnel
        Write-Host "â³ Äang láº¥y Ä‘á»‹a chá»‰ Ngrok..."
        try {
            $tunnels = Invoke-RestMethod -Uri "http://127.0.0.1:4040/api/tunnels"
            # TÃ¬m tunnel TCP Ä‘áº§u tiÃªn
            $tcpTunnel = $tunnels.tunnels | Where-Object {$_.proto -eq 'tcp'} | Select-Object -First 1
            if ($tcpTunnel) {
                Write-Host "--------------------------------------------------"
                Write-Host "âœ… Äá»‹a chá»‰ káº¿t ná»‘i RDP (Ngrok URL): $($tcpTunnel.public_url)"
                Write-Host "   (Sá»­ dá»¥ng Ä‘á»‹a chá»‰ nÃ y trong Remote Desktop Client)"
                Write-Host "--------------------------------------------------"
            } else {
                Write-Host "âš ï¸ KhÃ´ng tÃ¬m tháº¥y tunnel TCP tá»« API Ngrok. Kiá»ƒm tra log Ngrok."
            }
        } catch {
            Write-Host "âŒ Lá»—i khi láº¥y URL Ngrok: $_"
            Write-Host "   -> HÃ£y kiá»ƒm tra log cá»§a bÆ°á»›c 'Táº¡o Ngrok Tunnel' hoáº·c truy cáº­p http://127.0.0.1:4040 (náº¿u cÃ³ thá»ƒ)."
        }

    # BÆ°á»›c 7: Giá»¯ cho Workflow cháº¡y (Ä‘á»ƒ RDP vÃ  Ngrok khÃ´ng bá»‹ táº¯t)
    - name: Giá»¯ cho Workflow hoáº¡t Ä‘á»™ng
      run: |
        Write-Host "âœ… MÃ¡y áº£o Windows RDP Ä‘Ã£ sáºµn sÃ ng!"
        Write-Host "   Script sáº½ cháº¡y vÃ²ng láº·p Ä‘á»ƒ giá»¯ káº¿t ná»‘i..."
        # Táº£i vÃ  cháº¡y script vÃ²ng láº·p tá»« repo gá»‘c (hoáº·c táº¡o vÃ²ng láº·p Ä‘Æ¡n giáº£n)
        # Invoke-WebRequest https://raw.githubusercontent.com/30dayscoding/rdp/main/loop.ps1 -OutFile loop.ps1
        # ./loop.ps1
        # Hoáº·c dÃ¹ng vÃ²ng láº·p Ä‘Æ¡n giáº£n hÆ¡n:
        while ($true) { Start-Sleep -Seconds 60; Write-Host "..." } # In dáº¥u ... má»—i phÃºt
